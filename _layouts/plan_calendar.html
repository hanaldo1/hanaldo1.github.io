---
layout: default
---

{% assign plan = site.data.plan[page.plan_data] %}

<div class="plan-calendar">
  <div class="info-status">
    <section class="summary-section">
      <div id="summaryBody"></div>
    </section>

    <section class="info-section">
      <div id="dday" class="dday"></div>
      <br>
      <div id="startDate"></div>
      <strong><div id="endDate"></div></strong>
    </section>

    <section class="progress-section">
      <div id="progressText"></div>
      <div class="progress-bar">
        <div id="progressFill"></div>
      </div>

      <div class="gh-heatmap">
        <div id="ghGrid" class="gh-grid"></div>
      </div>
    </section>
  </div>

  <div id="calendar"></div>

  <div id="eventModal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-box">
      <button class="modal-close">&times;</button>

      <strong><h3 id="modalTitle"></h3></strong>
      <p id="modalDuration"></p>

      <ul id="modalChecklist" class="checklist"></ul>
      <p id="modalEmpty" class="modal-empty hidden">ìƒì„¸ ì²´í¬ë¦¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
  </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<script>
  const days = {{ plan.days | jsonify }};
  const start_date = {{ plan.start_date | jsonify }};
  const summaries = {{ plan.summaries | jsonify }};

  const start = new Date(start_date + "T00:00:00+09:00");
  const end = new Date(start);
  end.setDate(start.getDate() + (days -1)); // ì‹œì‘ì¼ í¬í•¨

  // Jekyll data -> JS events
  const plan_items = [
    {% for item in plan.items %}
    { 
      title: {{ item.title | jsonify }},
      start: {{ item.date | jsonify }} + "T00:00:00+09:00",
      allDay: true,
      extendedProps: {
        date: {{ item.date | default: "" | jsonify }},
        duration: {{ item.duration | default: "" | jsonify }},
        detail: {{ item.detail | default: empty | jsonify }},
        status: {{ item.status | default: "todo" | jsonify }}
      },
    },
    {% endfor %}
  ];

  document.addEventListener('DOMContentLoaded', function() {
    const el = document.getElementById('calendar');

    const calendar = new FullCalendar.Calendar(el, {
      initialView: 'dayGridMonth',
      locale: 'ko',
      height: 'auto',
      events: plan_items,

      eventClassNames: function(arg) {
        const classes = [
          "rounded-lg",
          "px-2",
          "py-0.5",
          "text-xs",
          "cursor-pointer",
          "transition"
        ];

        if (arg.event.extendedProps.status === "done") {
          classes.push("is-done", "bg-gray-100", "text-gray-400", "line-through");
        } else if (arg.event.extendedProps.status === "todo") {
          classes.push("is-todo", "bg-gray-200", "hover:bg-gray-300");
        }

        const today = new Date().toISOString().slice(0,10);
        if (arg.event.startStr === today) {
          classes.push("is-today");
        }

        return classes;
      },

      eventClick: function(info) {
        info.jsEvent.preventDefault();

        // ëª¨ë‹¬ ë Œë”ë§
        openModalForEvent(info.event);
      },

      // 1) ì™„ë£Œ ì´ë²¤íŠ¸ â€œì‚¬ë¼ì§€ëŠ” ëŠë‚Œâ€ ì¶”ê°€ ì²˜ë¦¬(ì›í•˜ë©´ ë” ê°•í•˜ê²Œ)
      eventDidMount: (info) => {
        const status = info.event.extendedProps.status;
        if (status === "done") {
          info.el.setAttribute("title", "ì™„ë£Œ");
        }
      },
    });

    // 1) ìš”ì•½ í‘œì‹œ
    renderSummary();

    // 2) ëª©í‘œ, ë””ë°ì´ ê³„ì‚° & í‘œì‹œ
    renderInfo();

    // 3) ì§„í–‰ë¥  í‘œì‹œ
    renderProgress();

    // 4) ìº˜ë¦°ë”
    calendar.render();

    // ëª¨ë‹¬ ë‹«ê¸° ì²˜ë¦¬
    document.querySelector(".modal-close").onclick = closeModal;
    document.querySelector(".modal-backdrop").onclick = closeModal;
  });

  function toYMD(dateObj) {
    // ë¡œì»¬ ê¸°ì¤€ yyyy-mm-dd
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth() + 1).padStart(2, "0");
    const d = String(dateObj.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  function getProcessPct() {
    const total = plan_items.length;
    const done = plan_items.filter(item => item.extendedProps.status === "done").length;
    const pct = total ? Math.round((done / total) * 100) : 0;

    return [total, done, pct];
  }

  function getToday() {
    const today = new Date();
    today.setHours(0,0,0,0);
    return today;
  }
  
  function renderSummary() {
    const summaryBody = document.getElementById('summaryBody');

    for (let i = 0; i < summaries.length; i++) {
      let summary = document.createElement("p");
      summary.textContent = `â–ªï¸ ${summaries[i].text}`;

      if (Object.hasOwn(summaries[i], 'link')) {
        summary = document.createElement("a");
        summary.href = summaries[i].link;
        summary.textContent = `â–ªï¸ ${summaries[i].text}`;
      }

      summaryBody.appendChild(summary);
    }
  }

  function renderInfo() {
    document.getElementById('startDate').textContent = `â–ªï¸ ì‹œì‘ì¼: ${toYMD(start)}`;
    document.getElementById('endDate').textContent = `â–ªï¸ ëª©í‘œì¼: ${toYMD(end)} (${days}ì¼)`;

    // ë””ë°ì´
    // í•œêµ­ ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œ ê³„ì‚°
    const today = getToday();

    const diffMs = end - today;
    const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

    const dday = document.getElementById("dday");
    if (!dday) return;

    if (diffDays > 0) {
      dday.textContent = `ğŸ¯ ëª©í‘œê¹Œì§€ D-${diffDays}`;
    } else if (diffDays === 0) {
      dday.textContent = `ğŸ”¥ ì˜¤ëŠ˜ì´ ëª©í‘œì¼!`;
    } else {
      dday.textContent = `âœ… ëª©í‘œ ë‹¬ì„± (D+${Math.abs(diffDays)})`;
    }
  }

  function renderProgress() {
    // ì§„í–‰ë¥ 
    const [total, done, pct] = getProcessPct();

    document.getElementById("progressText").textContent = `ğŸ“ ì „ì²´ ì§„í–‰ë¥ : ${done} / ${total} (${pct}%)`;
    document.getElementById("progressFill").style.width = `${pct}%`;

    // ê·¸ë¦¬ë“œ
    // date -> status map
    const map = new Map(plan_items.map(item => [item.extendedProps.date, item.extendedProps.status]));

    const today = getToday();

    const grid_start = new Date(start);

    // ==> ì£¼ì‹œì‘ì¼ë¶€í„° ê·¸ë¦¬ë“œ ìƒì„±í•˜ë ¤ë©´ ì•„ë˜ ì½”ë“œ ì£¼ì„ í•´ì œ
    // const day = grid_start.getDay(); // 0=ì¼, 1=ì›”, ..., 6=í† 
    // const diff = day % 7 // ì£¼ì‹œì‘ ë‚ ì§œ (ì¼ìš”ì¼)ë¶€í„° ê³„ì‚°í•˜ê¸° ìœ„í•¨
    // grid_start.setDate(grid_start.getDate() - diff);

    // const grid_days = days + diff // ì£¼ì‹œì‘ ë‚ ì§œë¶€í„° ê³„ì‚°í•˜ê¸° ìœ„í•´ ì¶”ê°€ëœ ê°’ ê°™ì´ ê³ ë ¤
    // const WEEK_DAYS = grid_days % 7 !== 0 ? Math.floor(grid_days / 7 + 1) * 7 : grid_days;

    const GRID_COLUMND = 3
    const WEEK_DAYS = days % GRID_COLUMND !== 0 ? Math.floor(days / GRID_COLUMND + 1) * GRID_COLUMND : days;

    const gridEl = document.getElementById("ghGrid");
    if (!gridEl) return;

    // ì—´ ìƒì„±
    gridEl.style.setProperty("--gh-columns", GRID_COLUMND);

    const cells = [];
    for (let i = 0; i < WEEK_DAYS; i++) {
      const cell_date = new Date(grid_start);
      cell_date.setDate(grid_start.getDate() + i);

      const ymd = toYMD(cell_date);
      const status = map.get(ymd);

      // ë ˆë²¨ ë§¤í•‘
      // level-0: ì•„ë¬´ ê²ƒë„ ì—†ìŒ
      // level-1: todo(ê³„íšë§Œ ìˆìŒ)
      // level-2: done(ì™„ë£Œ)
      const level = status === "done" ? 2 : status === "todo" ? 1 : 0;

      const cell = document.createElement("a");
      cell.href = "#"; // í•„ìš”í•˜ë©´ í•´ë‹¹ ë‚ ì§œ ìƒì„¸ë¡œ ë§í¬ ê°€ëŠ¥
      cell.className = `gh-box level-${level}`;
      cell.setAttribute("title", tooltipText(ymd, status));
      cell.addEventListener("click", (e) => e.preventDefault());

      // ì˜¤ëŠ˜ í‘œì‹œ(ì„ íƒ)
      if (toYMD(today) === ymd) cell.classList.add("cell-today");

      // ì‹œì‘ì¼, ì¢…ë£Œì¼ ë²”ìœ„ì—ì„œ ë²—ì–´ë‚˜ëŠ” ë‚ ì§œëŠ” ë¹ˆ ê·¸ë¦¬ë“œë¡œ ë³´ì´ê²Œ
      if (cell_date < start) cell.classList.add("cell-before-start");
      if (cell_date > end) cell.classList.add("cell-after-end");

      cells.push(cell);
    }

    cells.forEach(c => gridEl.appendChild(c));
  }

  function tooltipText(date, status) {
    if (status === "done") return `${date} Â· ì™„ë£Œ`;
    if (status === "todo") return `${date} Â· TODO`;
    return `${date} Â· ê³„íš ì—†ìŒ`;
  }

  function closeModal() {
    document.getElementById("eventModal").classList.add("hidden");
  }

  function openModalForEvent(event) {
    const modal = document.getElementById("eventModal");
    const listEl = document.getElementById("modalChecklist");
    const emptyEl = document.getElementById("modalEmpty");

    document.getElementById("modalTitle").textContent = event.title;
    document.getElementById("modalDuration").textContent = "ğŸ•‘ ì†Œìš”ì‹œê°„: "+ event.extendedProps.duration;

    // statusì— ë”°ë¼ ëª¨ë‹¬ í´ë˜ìŠ¤ í† ê¸€
    modal.classList.toggle("is-done", event.extendedProps.status === "done");

    // ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
    listEl.innerHTML = "";

    const detail = event.extendedProps.detail;

    // detailì´ ë°°ì—´ì´ë©´ ë Œë”ë§
    if (Array.isArray(detail) && detail.length > 0) {
      detail.forEach(text => {
        const li = document.createElement("li");
        li.textContent = text;
        listEl.appendChild(li);
      });
    } else {
      emptyEl.classList.remove("hidden");
    }

    modal.classList.remove("hidden");
  }
</script>